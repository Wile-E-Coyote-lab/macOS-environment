name: Notify Linear

on:
  push:
    branches:
      - main
      - feature/*

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read issue ID
        id: issue
        run: |
          if [ -f .linear/issue_id ]; then
            echo "issue_id=$(cat .linear/issue_id)" >> $GITHUB_OUTPUT
          else
            echo "issue_id=" >> $GITHUB_OUTPUT
          fi

      - name: Notify Linear via fetch
        if: ${{ steps.issue.outputs.issue_id != '' }}
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ISSUE_ID: ${{ steps.issue.outputs.issue_id }}
        run: |
          curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$ISSUE_ID" --arg actor "$GITHUB_ACTOR" --arg sha "$GITHUB_SHA" --arg branch "${GITHUB_REF#refs/heads/}" '{
              query: "mutation Comment($id: String!, $body: String!) { commentCreate(input: { issueId: $id, body: $body }) { success } }",
              variables: {
                id: $id,
                body: ("ðŸ“¦ Commit " + $sha + " by " + $actor + " on branch " + $branch)
              }
            }')"
