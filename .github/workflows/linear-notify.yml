name: Notify Linear

on:
  push:
    branches:
      - main
      - feature/*

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì• Extract Linear issue ID
        id: issue
        run: |
          if [ -f .linear/issue_id ]; then
            ISSUE_ID=$(cat .linear/issue_id | tr -d '\n')
            echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Found issue_id: $ISSUE_ID"
          else
            echo "issue_id=" >> $GITHUB_OUTPUT
            echo "::warning::No .linear/issue_id file found. Skipping Linear notification."
          fi

      - name: üîÅ Exchange OAuth code for access token
        if: ${{ steps.issue.outputs.issue_id != '' }}
        env:
          LINEAR_APP_ID: ${{ secrets.LINEAR_APP_ID }}
          LINEAR_CLIENT_SECRET: ${{ secrets.LINEAR_CLIENT_SECRET }}
          LINEAR_REDIRECT_URI: ${{ secrets.LINEAR_REDIRECT_URI }}
          LINEAR_OAUTH_CODE: ${{ secrets.LINEAR_OAUTH_CODE }}
        run: |
          echo "üîê Exchanging OAuth code for access token..."

          RESPONSE=$(curl -sS -X POST https://api.linear.app/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$LINEAR_APP_ID&client_secret=$LINEAR_CLIENT_SECRET&redirect_uri=$LINEAR_REDIRECT_URI&grant_type=authorization_code&code=$LINEAR_OAUTH_CODE")

          echo "$RESPONSE" | jq

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [[ "$ACCESS_TOKEN" == "null" || -z "$ACCESS_TOKEN" ]]; then
            echo "::error::‚ùå Token exchange failed. Invalid code or upstream error."
            exit 1
          fi

          echo "‚úÖ Access token acquired"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: üöÄ Notify Linear via GraphQL mutation
        if: ${{ steps.issue.outputs.issue_id != '' }}
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          ISSUE_ID: ${{ steps.issue.outputs.issue_id }}
        run: |
          echo "üì° Sending GraphQL mutation to Linear for issue $ISSUE_ID..."

          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$ISSUE_ID" \
                        --arg actor "$GITHUB_ACTOR" \
                        --arg sha "$GITHUB_SHA" \
                        --arg branch "${GITHUB_REF#refs/heads/}" '{
              query: "mutation Comment($id: String!, $body: String!) { commentCreate(input: { issueId: $id, body: $body }) { success } }",
              variables: {
                id: $id,
                body: ("üì¶ Commit " + $sha + " by " + $actor + " on branch " + $branch)
              }
            }')")

          echo "üîÅ Linear API response:"
          echo "$RESPONSE" | jq

          if echo "$RESPONSE" | jq -e '.data.commentCreate.success' | grep -q true; then
            echo "‚úÖ Comment successfully posted to Linear issue $ISSUE_ID"
          else
            echo "::error::‚ùå Failed to post comment to Linear"
            exit 1
          fi
