# .github/workflows/linear-notify.yml
name: Notify Linear

on:
  push:
    branches:
      - main
      - feature/*

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì• Extract Linear issue ID
        id: issue
        run: |
          if [ -f .linear/issue_id ]; then
            ISSUE_ID=$(cat .linear/issue_id | tr -d '\n')
            echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Found issue_id: $ISSUE_ID"
          else
            echo "issue_id=" >> $GITHUB_OUTPUT
            echo "::warning::No .linear/issue_id file found. Skipping Linear notification."
          fi

      - name: üîê Validate Linear API key and issue ID
        id: validate
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ISSUE_ID: ${{ steps.issue.outputs.issue_id }}
        run: |
          echo "üîç Validating mutation preconditions..."

          if [ -z "$LINEAR_API_KEY" ] || [ "$LINEAR_API_KEY" = "***" ]; then
            echo "::error::‚ùå LINEAR_API_KEY is missing, empty, or improperly injected"
            exit 1
          fi

          if [ -z "$ISSUE_ID" ]; then
            echo "::error::‚ùå issue_id is missing or empty"
            exit 1
          fi

          if ! [[ "$ISSUE_ID" =~ ^[A-Z]+-[0-9]+$ ]]; then
            echo "::error::‚ùå issue_id format invalid: '$ISSUE_ID'"
            exit 1
          fi

          echo "‚úÖ LINEAR_API_KEY is present (masked)"
          echo "‚úÖ issue_id = $ISSUE_ID"

      - name: üöÄ Notify Linear via GraphQL mutation
        if: ${{ steps.validate.outcome == 'success' }}
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ISSUE_ID: ${{ steps.issue.outputs.issue_id }}
        run: |
          echo "üì° Sending GraphQL mutation to Linear for issue $ISSUE_ID..."

          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: Bearer $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$ISSUE_ID" \
                        --arg actor "$GITHUB_ACTOR" \
                        --arg sha "$GITHUB_SHA" \
                        --arg branch "${GITHUB_REF#refs/heads/}" '{
              query: "mutation Comment($id: String!, $body: String!) { commentCreate(input: { issueId: $id, body: $body }) { success } }",
              variables: {
                id: $id,
                body: ("üì¶ Commit " + $sha + " by " + $actor + " on branch " + $branch)
              }
            }')")

          echo "üîÅ Linear API response:"
          echo "$RESPONSE" | jq

          if echo "$RESPONSE" | jq -e '.data.commentCreate.success' | grep -q true; then
            echo "‚úÖ Comment successfully posted to Linear issue $ISSUE_ID"
          else
            echo "::error::‚ùå Failed to post comment to Linear"
            exit 1
          fi
